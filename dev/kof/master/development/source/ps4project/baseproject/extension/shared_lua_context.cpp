#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wio.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_memcpy_s.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/sstream"
#include "program files (x86)/windows kits/8.1/include/um/winbase.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/utility"
#include "dev/kof/master/development/source/baseproject/jni/framework/memory/heapmemory.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/iosfwd"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/scalar_cpp/boolinvec.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/thread/mutex.h"
#include "dev/silverware/git/sdk/agmutex.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/thread"
#include "dev/silverware/git/sdk/agscopedlock.h"
#include "dev/silverware/git/sdk/agmemorystream.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/memory"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xmemory"
#include "dev/silverware/git/sdk/agmemorypool.h"
#include "dev/silverware/git/sdk/agreferencecountinl.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/thr/xthread"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_new.h"
#include "dev/silverware/git/sdk/input/agcontrollerbuttoncomponent.h"
#include "dev/kof/master/development/source/ps4project/baseproject/extension/memory_allocator.h"
#include "dev/silverware/git/sdk/agstream.h"
#include "dev/kof/master/development/source/ps4project/toolkit/geommath/vector3unaligned.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xstddef"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/type_traits"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/deque"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_atomic.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/vec_aos.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/boolinvec.h"
#include "dev/silverware/git/sdk/3rdparty/steam/steamclientpublic.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/scalar_cpp/vectormath_aos.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xatomic0.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/mutex"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/chrono"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/time.h"
#include "program files (x86)/windows kits/8.1/include/um/winnt.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/limits"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wtime.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/ctype.h"
#include "dev/silverware/git/sdk/agpointerinl.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/functional"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xstring"
#include "dev/kof/master/development/source/ps4project/baseproject/pcutil/pcdummy.h"
#include "dev/silverware/git/sdk/system/agsysteminfo.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xmemory0"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/exception"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xfacet"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/malloc.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/scalar_cpp/mat_aos.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/list"
#include "dev/kof/master/development/source/ps4project/baseproject/pcutil/pccontrolsmanager.h"
#include "dev/silverware/git/sdk/input/aginputmanager.h"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_refcount.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/wchar.h"
#include "dev/silverware/git/sdk/agsingleton.h"
#include "dev/kof/master/development/source/ps4project/toolkit/geommath/vector4unaligned.h"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_memory.h"
#include "dev/silverware/git/sdk/agsemaphore.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wconio.h"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_memoryheap.h"
#include "dev/silverware/git/sdk/agsemaphore.inl"
#include "dev/silverware/git/sdk/agconditionvariable.h"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_stats.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/condition_variable"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_timer.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/vecidx_aos.h"
#include "dev/silverware/git/sdk/platforms/pc/system/agpcsysteminfo.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/floatinvec.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/debug/logging.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/quat_aos.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/scalar_cpp/floatinvec.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/memory/globalheapmemory.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/memory/fixmemory.h"
#include "dev/silverware/git/sdk/agvector2.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/libcommon.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/internal/internal_vec64.h"
#include "dev/silverware/git/sdk/agmath.h"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_sysalloc.h"
#include "dev/silverware/git/sdk/input/agcontroller.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/array"
#include "dev/silverware/git/sdk/system/aguser.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/algorithm"
#include "dev/silverware/git/sdk/agstring.h"
#include "program files (x86)/windows kits/8.1/include/shared/stralign.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/internal/internal_math.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/string"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_typeinfo.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/istream"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/scalar_cpp/vec_aos.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/ostream"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/ios"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xutility"
#include "dev/silverware/git/sdk/3rdparty/steam/isteamhtmlsurface.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocnum"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/streambuf"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/map"
#include "dev/silverware/git/sdk/memory/agallocators.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtree"
#include "dev/silverware/git/sdk/input/agcontrollercomponent.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xiosbase"
#include "dev/silverware/git/sdk/agreferencedobjectinl.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocale"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/cmath"
#include "dev/silverware/git/sdk/util/agdelegate.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocinfo"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/mat_aos.h"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_threads.h"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_allocinfo.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/sys/stat.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/memory/variableheapmemorybase.h"
#include "dev/silverware/git/sdk/agthread.h"
#include "dev/kof/master/development/source/ps4project/toolkit/geommath/matrix4unaligned.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/scalar_cpp/quat_aos.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtgmath.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtr1common"
#include "dev/kof/master/development/source/baseproject/jni/framework/memory/physicalheapmemory.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/stdlib.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_exception.h"
#include "dev/silverware/git/sdk/3rdparty/steam/steam_api_internal.h"
#include "dev/silverware/git/sdk/agpointer.h"
#include "dev/silverware/git/sdk/agconditionvariable.inl"
#include "program files (x86)/windows kits/8.1/include/shared/guiddef.h"
#include "dev/silverware/git/sdk/agreferencedobject.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/system_error"
#include "dev/silverware/git/sdk/agreferencecount.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vector"
#include "dev/silverware/git/sdk/agmutex.inl"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/stdexcept"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/internal/internal_sse.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/stdio.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/internal/internal_types.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wstdio.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wstring.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_stdio_config.h"
#include "dev/silverware/git/sdk/3rdparty/steam/steam_api.h"
#include "program files (x86)/windows kits/8.1/include/um/winuser.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/tuple"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/math.h"
#include "dev/silverware/git/sdk/input/agsdlmappingparser.h"
#include "dev/kof/master/development/source/ps4project/baseproject/extension/shared_lua_context.h"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_array.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/thread/jobmanager.h"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/sf_allocator.h"
#include "dev/kof/master/development/source/ps4project/toolkit/geommath/vector2unaligned.h"
#include "dev/kof/master/development/source/middleware/autodesk/scaleform/gfx_sdk/src/kernel/heapmh/heapmh_sysallocmalloc.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/ag/3rdparty/vectormath/cpp/internal/internal_functions.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vadefs.h"
#include "program files (x86)/windows kits/8.1/include/shared/basetsd.h"
#include "dev/silverware/git/sdk/3rdparty/steam/matchmakingtypes.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/string.h"
#include "dev/kof/master/development/source/baseproject/jni/framework/util/resourcemanager.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_memory.h"
#include "dev/kof/master/development/source/ps4project/baseproject/extension/lua/src/lapi.c"
#include "dev/kof/master/development/source/ps4project/baseproject/extension/lua/src/lvm.c"
#include "dev/kof/master/development/source/ps4project/baseproject/extension/lua/src/lstate.c"
#include "dev/kof/master/development/source/ps4project/baseproject/extension/lua/src/lgc.c"

std::piecewise_construct_t std::piecewise_construct; // 0x1408AF11D
extension::SharedLuaContext::~SharedLuaContext(); // 0x1402B0B20
void extension::SharedLuaContext::Open(); // 0x1402B0B70
void extension::SharedLuaContext::AddRef(); // 0x1402B0C70
void extension::SharedLuaContext::Release(); // 0x1402B0D40
long extension::SharedLuaContext::LuaErrorHandler(lua_State * L); // 0x1402B0E40//decompilation failure at 1408AF11D!
void __fastcall extension::SharedLuaContext::~SharedLuaContext(extension::SharedLuaContext *this)
{
  extension::MemoryAllocator *m_pMemoryAllocator; // rcx

  if ( this->m_Context )
    extension::SharedLuaContext::Release(this);
  m_pMemoryAllocator = this->m_pMemoryAllocator;
  if ( m_pMemoryAllocator )
  {
    ((void (__fastcall *)(extension::MemoryAllocator *, __int64))m_pMemoryAllocator->~MemoryAllocator)(
      m_pMemoryAllocator,
      1i64);
    this->m_pMemoryAllocator = 0i64;
  }
  if ( this->m_pAllocatorMemory )
    this->m_pAllocatorMemory = 0i64;
}

void __fastcall extension::SharedLuaContext::AddRef(extension::SharedLuaContext *this)
{
  lua_State *m_Context; // rbx
  lua_TValue *p_key; // rcx
  int tt; // eax
  int n; // eax
  lua_TValue *v5; // rdx
  lua_TValue key; // [rsp+20h] [rbp-18h] BYREF
  float result; // [rsp+40h] [rbp+8h] BYREF

  m_Context = this->m_Context;
  key.value_.gc = (GCObject *)"SharedLuaContext reference count registry key";
  key.tt_ = 2;
  *m_Context->top++ = luaH_get((Table *)m_Context->l_G->l_registry.value_.gc, &key)->i_val;
  p_key = m_Context->top - 1;
  tt = p_key->tt_;
  if ( tt != 3 )
  {
    if ( (tt & 0xF) != 4 || !luaO_str2d((const char *)&p_key->value_.gc->th.l_G, p_key->value_.gc->ts.tsv.len, &result) )
    {
      n = 0;
      goto LABEL_6;
    }
    p_key = &key;
    key.value_.n = result;
    key.tt_ = 3;
  }
  n = (int)p_key->value_.n;
LABEL_6:
  v5 = --m_Context->top;
  v5->tt_ = 3;
  v5->value_.n = (float)(n + 1);
  ++m_Context->top;
  lua_rawsetp(m_Context, (int)v5, "SharedLuaContext reference count registry key");
}

__int64 __fastcall extension::SharedLuaContext::LuaErrorHandler(lua_State *L)
{
  lua_TValue *top; // rcx
  const char *p_l_G; // rdi
  int tt; // eax
  lua_TValue *v5; // rcx
  global_State *l_G; // rcx
  __int64 v7; // rax
  lua_TValue *v8; // rcx
  lua_TValue *v9; // rax
  global_State *v10; // rcx
  __int64 v11; // rax

  lua_checkstack(L, 20);
  top = L->top;
  p_l_G = 0i64;
  if ( (unsigned int)(((char *)top - (char *)L->ci->func - 16) >> 4) )
  {
    tt = top[-1].tt_;
    v5 = top - 1;
    if ( (tt & 0xF) != 4 )
    {
      if ( !(unsigned int)luaV_tostring(L, v5) )
        goto LABEL_10;
      l_G = L->l_G;
      if ( l_G->GCdebt > 0 )
      {
        if ( l_G->gcrunning )
        {
          luaC_forcestep(L);
        }
        else
        {
          v7 = l_G->GCdebt + 2400;
          l_G->GCdebt = -2400i64;
          l_G->totalbytes += v7;
        }
      }
      v5 = L->top - 1;
    }
    p_l_G = (const char *)&v5->value_.gc->th.l_G;
  }
LABEL_10:
  luaL_traceback(L, L, p_l_G, 0);
  if ( p_l_G )
  {
    v8 = L->top;
    v9 = v8 - 1;
    if ( &v8[-1] < v8 )
    {
      do
      {
        v9[-1].value_.gc = v9->value_.gc;
        v9[-1].tt_ = v9->tt_;
        ++v9;
      }
      while ( v9 < L->top );
    }
    --L->top;
  }
  if ( (L->top[-1].tt_ & 0xF) != 4 )
  {
    if ( (unsigned int)luaV_tostring(L, L->top - 1) )
    {
      v10 = L->l_G;
      if ( v10->GCdebt > 0 )
      {
        if ( v10->gcrunning )
        {
          luaC_forcestep(L);
        }
        else
        {
          v11 = v10->GCdebt + 2400;
          v10->GCdebt = -2400i64;
          v10->totalbytes += v11;
        }
      }
    }
  }
  _DummyLogging("SCRIPT ERROR:%s");
  return 1i64;
}

void __fastcall extension::SharedLuaContext::Open(extension::SharedLuaContext *this)
{
  Framework::GLManager *v2; // rdx
  unsigned __int64 size; // rbx
  extension::MemoryAllocator *v4; // rax
  lua_State *v5; // rax
  const luaL_Reg *v6; // rbx
  __int64 (__fastcall *i)(lua_State *); // rax
  lua_State *m_Context; // rcx
  lua_TValue *top; // rax
  extension::MemoryAllocator *v10; // [rsp+40h] [rbp+8h]

  v2 = Framework::GLManager::glm;
  this->m_pAllocatorMemory = Framework::GLManager::glm->allocateLuaScriptBuffers.pools.area;
  size = v2->allocateLuaScriptBuffers.pools.size;
  v10 = (extension::MemoryAllocator *)operator new(0x18ui64);
  extension::MemoryAllocator::MemoryAllocator(v10, this->m_pAllocatorMemory, size, 0x40u);
  this->m_pMemoryAllocator = v4;
  v5 = (lua_State *)lua_newstate(extension::_anonymous_namespace_::MyLuaAlloc_MemoryAllocator, v4);
  this->m_Context = v5;
  v5->l_G->panic = (int (__fastcall *)(lua_State *))extension::SharedLuaContext::LuaErrorHandler;
  v6 = modules;
  for ( i = luaopen_base; i; i = (__int64 (__fastcall *)(lua_State *))v6->func )
  {
    luaL_requiref(this->m_Context, v6->name, (int (__fastcall *)(lua_State *))i, 1);
    --this->m_Context->top;
    ++v6;
  }
  m_Context = this->m_Context;
  top = this->m_Context->top;
  top->value_.gc = (GCObject *)extension::_anonymous_namespace_::MyLuaPrint;
  top->tt_ = 22;
  ++m_Context->top;
  lua_setglobal(this->m_Context, "print");
  extension::SharedLuaContext::AddRef(this);
}

void __fastcall extension::SharedLuaContext::Release(extension::SharedLuaContext *this)
{
  lua_State *m_Context; // rbx
  Node *v3; // rax
  lua_TValue *top; // rdx
  lua_TValue *p_key; // rcx
  int tt; // eax
  int n; // eax
  int v8; // ecx
  lua_TValue *v9; // rax
  lua_TValue key; // [rsp+20h] [rbp-18h] BYREF
  float result; // [rsp+40h] [rbp+8h] BYREF

  m_Context = this->m_Context;
  key.value_.gc = (GCObject *)"SharedLuaContext reference count registry key";
  key.tt_ = 2;
  v3 = luaH_get((Table *)m_Context->l_G->l_registry.value_.gc, &key);
  top = m_Context->top;
  *top = v3->i_val;
  p_key = m_Context->top++;
  tt = p_key->tt_;
  if ( tt == 3 )
    goto LABEL_5;
  if ( (tt & 0xF) == 4 && luaO_str2d((const char *)&p_key->value_.gc->th.l_G, p_key->value_.gc->ts.tsv.len, &result) )
  {
    p_key = &key;
    key.value_.n = result;
    key.tt_ = 3;
LABEL_5:
    n = (int)p_key->value_.n;
    goto LABEL_6;
  }
  n = 0;
LABEL_6:
  --m_Context->top;
  v8 = n - 1;
  v9 = m_Context->top;
  if ( v8 <= 0 )
  {
    close_state(m_Context->l_G->mainthread);
  }
  else
  {
    v9->tt_ = 3;
    v9->value_.n = (float)v8;
    ++m_Context->top;
    lua_rawsetp(m_Context, (int)top, "SharedLuaContext reference count registry key");
  }
  this->m_Context = 0i64;
}

