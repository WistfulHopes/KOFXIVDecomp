#include "program files (x86)/microsoft visual studio 14.0/vc/include/xstddef"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/mutex"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xatomic0.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/map"
#include "dev/silverware/git/sdk/agmath.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/chrono"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/system_error"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtree"
#include "program files (x86)/windows kits/8.1/include/shared/stralign.h"
#include "dev/silverware/git/sdk/system/agsysteminfo.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vector"
#include "dev/silverware/git/sdk/agmutex.inl"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wio.h"
#include "dev/silverware/git/sdk/agreferencecountinl.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wstring.h"
#include "dev/silverware/git/sdk/agcondition.inl"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xutility"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/utility"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/iosfwd"
#include "dev/silverware/git/sdk/platforms/pc/system/agpcsysteminfo.h"
#include "program files (x86)/windows kits/8.1/include/shared/winerror.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocinfo"
#include "program files (x86)/windows kits/8.1/include/shared/guiddef.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xiosbase"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/ctype.h"
#include "dev/silverware/git/sdk/agcondition.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocale"
#include "dev/silverware/git/sdk/util/agservicecommand.h"
#include "dev/silverware/git/sdk/agconditionvariable.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/condition_variable"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/string.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_memory.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_memcpy_s.h"
#include "dev/silverware/git/sdk/agpointerinl.h"
#include "dev/silverware/git/sdk/agvector3.h"
#include "dev/silverware/git/sdk/3rdparty/steam/isteamhtmlsurface.h"
#include "program files (x86)/windows kits/8.1/include/um/oleauto.h"
#include "dev/silverware/git/sdk/agsemaphore.inl"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/malloc.h"
#include "dev/silverware/git/sdk/agrectangle.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/cmath"
#include "program files (x86)/windows kits/8.1/include/um/winnt.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/math.h"
#include "program files (x86)/windows kits/8.1/include/shared/basetsd.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/sys/stat.h"
#include "dev/silverware/git/sdk/3rdparty/steam/steam_api_internal.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/algorithm"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xstring"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xmemory0"
#include "dev/silverware/git/sdk/filesystem/agdirectory.h"
#include "dev/silverware/git/sdk/agreferenceinl.h"
#include "dev/silverware/git/sdk/agscratch.h"
#include "dev/silverware/git/sdk/3rdparty/steam/steam_api.h"
#include "dev/silverware/git/sdk/memory/agallocators.h"
#include "dev/silverware/git/sdk/agsingleton.h"
#include "program files (x86)/windows kits/8.1/include/um/winuser.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/stdio.h"
#include "dev/silverware/git/sdk/system/agusermanager.h"
#include "dev/silverware/git/sdk/filesystem/agmount.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wstdio.h"
#include "dev/silverware/git/sdk/system/aguser.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_new.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_stdio_config.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/list"
#include "dev/silverware/git/sdk/util/agdelegate.h"
#include "dev/silverware/git/sdk/agconditionvariable.inl"
#include "dev/silverware/git/sdk/agreferencedobjectinl.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xmemory"
#include "dev/silverware/git/sdk/agarchive.h"
#include "dev/silverware/git/sdk/agpointer.h"
#include "dev/silverware/git/sdk/input/agcontrollerbuttoncomponent.h"
#include "dev/silverware/git/sdk/input/aginputmanager.h"
#include "dev/silverware/git/sdk/agreferencedobject.h"
#include "dev/silverware/git/sdk/input/agcontroller.h"
#include "dev/silverware/git/sdk/input/agcontrollercomponent.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/thr/xthread"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/wchar.h"
#include "dev/silverware/git/sdk/3rdparty/steam/matchmakingtypes.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/functional"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wconio.h"
#include "dev/silverware/git/sdk/agstream.h"
#include "dev/silverware/git/sdk/agmemorystream.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_exception.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/limits"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wtime.h"
#include "program files (x86)/windows kits/8.1/include/um/propidl.h"
#include "program files (x86)/windows kits/8.1/include/um/winbase.h"
#include "dev/silverware/git/sdk/util/agdebugchannels.h"
#include "dev/silverware/git/sdk/agreferencecount.h"
#include "dev/kof/master/development/source/ps4project/baseproject/ag/kofapplication.h"
#include "dev/silverware/git/sdk/util/agperformancecounter.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/thread"
#include "dev/silverware/git/sdk/filesystem/agfile.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/memory"
#include "dev/silverware/git/sdk/agmutex.h"
#include "dev/silverware/git/sdk/agthreadpool.h"
#include "dev/silverware/git/sdk/agscopedlock.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xfacet"
#include "dev/silverware/git/sdk/util/agservice.h"
#include "dev/silverware/git/sdk/agsemaphore.h"
#include "dev/silverware/git/sdk/agthread.h"
#include "dev/silverware/git/sdk/filesystem/agpath.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/tuple"
#include "dev/silverware/git/sdk/agclock.h"
#include "dev/silverware/git/sdk/agstring.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtgmath.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtr1common"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/string"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_typeinfo.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/stdlib.h"
#include "dev/silverware/git/sdk/3rdparty/steam/steamclientpublic.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vadefs.h"
#include "dev/silverware/git/sdk/system/agwindowconfig.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/ios"
#include "dev/silverware/git/sdk/agdisplay.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocnum"
#include "dev/silverware/git/sdk/agvector4.h"
#include "dev/silverware/git/sdk/agvector2.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/time.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/stdexcept"
#include "dev/silverware/git/sdk/agmemorypool.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/exception"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/type_traits"

std::piecewise_construct_t std::piecewise_construct; // 0x1408AECC2
KOFApplication::KOFApplication(long(*func)()); // 0x140243790
KOFApplication::CCallbackInternal_OnGameOverlayActivated::~CCallbackInternal_OnGameOverlayActivated(); // 0x1402438C0
void KOFApplication::LoadWAD(); // 0x1402438E0
long CustomUnhandledExceptionFilter(_EXCEPTION_POINTERS * ExceptionInfo); // 0x140243A60
void KOFApplication::kofInit(); // 0x140243B80
void KOFApplication::kofExit(); // 0x140243C70
void KOFApplication::onExecuteImpl(); // 0x140243CF0
void KOFApplication::onJoinThread(); // 0x140243D10
const AgString & KOFApplication::getDirectory(); // 0x140243D20//decompilation failure at 1408AECC2!
void __fastcall AgPointer<AgBuffer<AgAllocator<1>>>::AgPointer<AgBuffer<AgAllocator<1>>>(
        AgPointer<AgPlayer> *this,
        const AgPointer<AgPlayer> *rhs)
{
  AgReferenceCount *m_ref; // rsi
  int m_strongCount; // ebx

  this->m_ref = 0i64;
  this->m_ptr = 0i64;
  m_ref = rhs->m_ref;
  if ( rhs->m_ref )
  {
    m_strongCount = m_ref->m_strongCount;
    if ( m_ref->m_strongCount )
    {
      while ( AgAtomicCompareExchange(&m_ref->m_strongCount, m_strongCount, m_strongCount + 1) != m_strongCount )
      {
        m_strongCount = m_ref->m_strongCount;
        if ( !m_ref->m_strongCount )
          return;
      }
      if ( m_strongCount != -1 )
      {
        this->m_ref = rhs->m_ref;
        this->m_ptr = rhs->m_ptr;
      }
    }
  }
}

void __fastcall AgPointer<AgUser>::AgPointer<AgUser>(AgPointer<AgUser> *this, AgUser *t)
{
  int ReferenceCounter; // eax
  AgReferenceCount *m_refCount; // rbx

  this->m_ref = 0i64;
  this->m_ptr = 0i64;
  if ( t )
  {
    ReferenceCounter = AgReferencedObject::createReferenceCounter(&t->AgReferencedObject, t);
    m_refCount = t->m_refCount;
    if ( !ReferenceCounter )
      AgReferenceCount::incRef(t->m_refCount);
    this->m_ref = m_refCount;
    this->m_ptr = t;
  }
}

void __fastcall KOFApplication::KOFApplication(KOFApplication *this, int (__fastcall *func)())
{
  AgProgram::AgProgram(this);
  this->__vftable = (KOFApplication_vtbl *)&KOFApplication::`vftable';
  this->m_mainFunc = kof_main;
  AgClock::AgClock(&this->m_clock, -1.0);
  *(_QWORD *)&this->m_quitFlag = 0i64;
  this->m_keyboardButtonPatch.m_ref = 0i64;
  this->m_keyboardButtonPatch.m_ptr = 0i64;
  this->m_steamcallback_OnGameOverlayActivated.m_nCallbackFlags = 0;
  this->m_steamcallback_OnGameOverlayActivated.m_iCallback = 0;
  this->m_steamcallback_OnGameOverlayActivated.__vftable = (KOFApplication::CCallbackInternal_OnGameOverlayActivated_vtbl *)&KOFApplication::CCallbackInternal_OnGameOverlayActivated::`vftable';
  SteamAPI_RegisterCallback(&this->m_steamcallback_OnGameOverlayActivated, 331i64);
  this->m_overlayPause = 0;
  AgClock::reset(&this->m_clock);
  AgClock::setMaxElapsedFrameTime(&this->m_clock, 0.5);
  this->m_processStartTime = AgClock::getSystemTime();
}

void __fastcall AgPointer<AgUser>::~AgPointer<AgUser>(AgPointer<KOFApplication> *this)
{
  KOFApplication *m_ptr; // rdi
  AgReferenceCount *m_ref; // rbx
  int v3; // esi

  m_ptr = this->m_ptr;
  this->m_ptr = 0i64;
  m_ref = this->m_ref;
  if ( this->m_ref )
  {
    this->m_ref = 0i64;
    v3 = 0;
    if ( !AgAtomicDecrement(&m_ref->m_strongCount) )
    {
      if ( !AgAtomicDecrement(&m_ref->m_weakCount) )
        v3 = 1;
      m_ref->m_data = 0i64;
      if ( m_ptr )
        ((void (__fastcall *)(KOFApplication *, __int64))m_ptr->~AgIThreadHost)(m_ptr, 1i64);
      if ( v3 )
        AgReferenceCount::operator delete(m_ref);
    }
  }
}

void __fastcall KOFApplication::CCallbackInternal_OnGameOverlayActivated::~CCallbackInternal_OnGameOverlayActivated(
        KOFApplication::CCallbackInternal_OnGameOverlayActivated *this)
{
  bool v1; // zf

  v1 = (this->m_nCallbackFlags & 1) == 0;
  this->__vftable = (KOFApplication::CCallbackInternal_OnGameOverlayActivated_vtbl *)&CCallbackImpl<1>::`vftable';
  if ( !v1 )
    SteamAPI_UnregisterCallback(this);
}

__int64 __fastcall CustomUnhandledExceptionFilter(_EXCEPTION_POINTERS *ExceptionInfo)
{
  HANDLE FileA; // rdi
  DWORD CurrentProcessId; // ebx
  HANDLE CurrentProcess; // rax
  _MINIDUMP_EXCEPTION_INFORMATION ExceptionParam; // [rsp+40h] [rbp-168h] BYREF
  __int64 result; // [rsp+50h] [rbp-158h] BYREF
  tm ptm; // [rsp+58h] [rbp-150h] BYREF
  char string[272]; // [rsp+80h] [rbp-128h] BYREF

  time64(&result);
  localtime64_s(&ptm, &result);
  strftime(string, 0x103ui64, "minidump-%Y%m%d%H%M%S.dmp", &ptm);
  FileA = CreateFileA(string, 0x40000000u, 2u, 0i64, 2u, 0x80u, 0i64);
  if ( FileA != (HANDLE)-1i64 )
  {
    ExceptionParam.ThreadId = GetCurrentThreadId();
    ExceptionParam.ExceptionPointers = ExceptionInfo;
    ExceptionParam.ClientPointers = 1;
    CurrentProcessId = GetCurrentProcessId();
    CurrentProcess = GetCurrentProcess();
    MiniDumpWriteDump(CurrentProcess, CurrentProcessId, FileA, MiniDumpNormal, &ExceptionParam, 0i64, 0i64);
    CloseHandle(FileA);
  }
  return 0i64;
}

void __fastcall KOFApplication::LoadWAD(KOFApplication *this)
{
  int v1; // ebx
  __int128 *v2; // rax
  AgReferenceCount *m_ref; // rdi
  int m_strongCount; // ebx
  AgPointer<AgMount> value; // [rsp+38h] [rbp-39h] BYREF
  AgPointer<AgMount> v6; // [rsp+48h] [rbp-29h] BYREF
  AgString v7; // [rsp+58h] [rbp-19h] BYREF
  AgString copy; // [rsp+68h] [rbp-9h] BYREF
  __int128 v9; // [rsp+78h] [rbp+7h] BYREF
  AgString v10; // [rsp+88h] [rbp+17h] BYREF
  __int64 v11; // [rsp+98h] [rbp+27h]
  __int128 v12; // [rsp+A8h] [rbp+37h] BYREF
  AgStringRef v13; // [rsp+B8h] [rbp+47h] BYREF

  v11 = -2i64;
  AgString::AgString(&copy, "content:assets.wad", -1);
  AgString::AgString(&v7, &copy);
  AgPath::clean((AgPath *)&v7);
  v1 = AgFile::exists((const AgPath *)&v7);
  AgString::~AgString(&v7);
  if ( v1 )
  {
    AgString::AgString(&v10, "archive", -1);
    AgStringRef::AgStringRef(&v13, &copy);
    v12 = *v2;
    v9 = 0i64;
    ((void (__fastcall *)(AgSingleton<AgFileSystem> *, AgPointer<AgMount> *, AgString *, __int64, __int128 *, __int128 *))AgSingleton<AgFileSystem>::ms_instance->__vftable[1].onSingletonExit)(
      AgSingleton<AgFileSystem>::ms_instance,
      &value,
      &v10,
      1i64,
      &v12,
      &v9);
    AgString::~AgString(&v10);
    if ( !value.m_ptr || value.m_ptr->m_error.error )
    {
      AgTrace("Error Loading archive!");
    }
    else
    {
      v6 = 0i64;
      m_ref = value.m_ref;
      if ( value.m_ref )
      {
        m_strongCount = value.m_ref->m_strongCount;
        if ( value.m_ref->m_strongCount )
        {
          while ( AgAtomicCompareExchange(&m_ref->m_strongCount, m_strongCount, m_strongCount + 1) != m_strongCount )
          {
            m_strongCount = m_ref->m_strongCount;
            if ( !m_ref->m_strongCount )
              goto LABEL_11;
          }
          if ( m_strongCount != -1 )
            v6 = value;
        }
      }
LABEL_11:
      AgFileSystem::mount((AgFileSystem *)AgSingleton<AgFileSystem>::ms_instance, &v6);
    }
    AgPointer<AgUser>::~AgPointer<AgUser>((AgPointer<KOFApplication> *)&value);
  }
  AgString::~AgString(&copy);
}

void __fastcall KOFApplication::CCallbackInternal_OnGameOverlayActivated::Run(
        KOFApplication::CCallbackInternal_OnGameOverlayActivated *this,
        void *pvParam)
{
  if ( AgSingleton<AgInputManager>::ms_instance )
  {
    AgInputManager::clearControls((AgInputManager *)AgSingleton<AgInputManager>::ms_instance);
    LODWORD(this[1].__vftable) = *(unsigned __int8 *)pvParam;
  }
  else
  {
    LODWORD(this[1].__vftable) = *(unsigned __int8 *)pvParam;
  }
}

AgString *__fastcall KOFApplication::getDirectory()
{
  if ( dword_140ACDB20 <= *(_DWORD *)(*(_QWORD *)NtCurrentTeb()->Reserved1[11] + 40i64) )
    return &sc_directory;
  Init_thread_header(&dword_140ACDB20);
  if ( dword_140ACDB20 != -1 )
    return &sc_directory;
  AgString::AgString(&sc_directory, ".", -1);
  atexit(KOFApplication::getDirectory_::_2_::_dynamic_atexit_destructor_for__sc_directory__);
  Init_thread_footer(&dword_140ACDB20);
  return &sc_directory;
}

void __fastcall KOFApplication::kofExit(KOFApplication *this)
{
  AgString mountPoint; // [rsp+28h] [rbp-30h] BYREF
  AgPointer<AgMount> result; // [rsp+38h] [rbp-20h] BYREF

  AgString::AgString(&mountPoint, "savedata", -1);
  AgFileSystem::getMount((AgFileSystem *)AgSingleton<AgFileSystem>::ms_instance, &result, &mountPoint);
  AgString::~AgString(&mountPoint);
  if ( result.m_ptr )
    result.m_ptr->unmount(result.m_ptr);
  AgSilverware::postUpdate();
  AgSilverware::cleanup();
  SetThreadExecutionState(0x80000000);
  AgPointer<AgUser>::~AgPointer<AgUser>((AgPointer<KOFApplication> *)&result);
}

void __fastcall KOFApplication::kofInit(KOFApplication *this)
{
  AgStringRef *v1; // rax
  AgStringRef *v2; // rax
  KOFApplication *v3; // rcx
  AgStringRef v4; // [rsp+20h] [rbp-58h] BYREF
  AgStringRef v5; // [rsp+30h] [rbp-48h] BYREF
  AgPointer<KOFApplication> v6; // [rsp+40h] [rbp-38h] BYREF
  AgStringRef v7; // [rsp+50h] [rbp-28h] BYREF
  AgStringRef v8; // [rsp+60h] [rbp-18h] BYREF

  AgTrace("[KOFApplication Init] Initializing debug info...");
  SetThreadExecutionState(0x80000003);
  SetUnhandledExceptionFilter((LPTOP_LEVEL_EXCEPTION_FILTER)CustomUnhandledExceptionFilter);
  AgScratch::init(0x100000u);
  AgTrace("[KOFApplication Init] Initializing SilverWare");
  AgStringRef::AgStringRef(&v7, &pnewText);
  v4 = *v1;
  AgStringRef::AgStringRef(&v8, &pnewText);
  v5 = *v2;
  AgSilverware::initialize(&v5, &v4, 0x3077ui64);
  AgTrace("[KOFApplication Init] Loading WAD file");
  KOFApplication::LoadWAD(v3);
  AgTrace("[KOFApplication Init] Registering error handlers");
  AgFileSystem::registerSaveErrorHandler((AgFileSystem *)AgSingleton<AgFileSystem>::ms_instance);
  AgTrace("[KOFApplication Init] Mounting save data");
  ((void (__fastcall *)(AgSingleton<AgFileSystem> *, AgPointer<KOFApplication> *, __int64))AgSingleton<AgFileSystem>::ms_instance->__vftable[1].~AgSingleton<AgFileSystem>)(
    AgSingleton<AgFileSystem>::ms_instance,
    &v6,
    3i64);
  AgPointer<AgUser>::~AgPointer<AgUser>(&v6);
}

void __fastcall KOFApplication::onExecuteImpl(KOFApplication *this)
{
  KOFApplication *v2; // rcx

  KOFApplication::kofInit(this);
  this->m_mainFunc();
  KOFApplication::kofExit(v2);
}

void __fastcall KOFApplication::onJoinThread(KOFApplication *this)
{
  this->m_quitFlag = 1;
}

