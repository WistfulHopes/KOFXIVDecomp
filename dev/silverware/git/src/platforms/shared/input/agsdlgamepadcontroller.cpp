#include "dev/silverware/git/sdk/agmutex.inl"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtr1common"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/string"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_typeinfo.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/stdlib.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/ios"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocnum"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/stdexcept"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/exception"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/type_traits"
#include "dev/silverware/git/sdk/input/agcontrolleraxiscomponent.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtree"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xstddef"
#include "dev/silverware/git/sdk/input/agcontrollerbuttoncomponent.h"
#include "dev/silverware/git/sdk/agreferencecount.h"
#include "dev/silverware/git/sdk/agstream.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xatomic0.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/system_error"
#include "dev/silverware/git/sdk/util/agperformancecounter.h"
#include "dev/silverware/git/sdk/agclock.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wio.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wstring.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/map"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/tuple"
#include "dev/silverware/git/sdk/input/agcontrollercomponent.h"
#include "dev/silverware/git/sdk/util/agdelegate.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xutility"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/utility"
#include "dev/silverware/git/sdk/util/agjsondata.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/iosfwd"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocinfo"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xiosbase"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/ctype.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocale"
#include "dev/silverware/git/src/platforms/shared/input/agsdlinputmanager.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/string.h"
#include "dev/silverware/git/sdk/input/aginputmanager.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_memory.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_memcpy_s.h"
#include "dev/silverware/git/sdk/agreferencecountinl.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vector"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/malloc.h"
#include "dev/silverware/git/sdk/input/agcontrollerrumblecomponent.h"
#include "dev/silverware/git/sdk/system/agsystemmanager.h"
#include "dev/silverware/git/sdk/agsingleton.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/functional"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/cmath"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/math.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/sys/stat.h"
#include "dev/silverware/git/sdk/agpointerinl.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/thr/xthread"
#include "dev/silverware/git/sdk/system/agsystemconfig.h"
#include "dev/silverware/git/sdk/util/agdebugchannels.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xstring"
#include "dev/silverware/git/sdk/agmutex.h"
#include "dev/silverware/git/src/platforms/pc/sdl/include/sdl_stdinc.h"
#include "dev/silverware/git/sdk/agscopedlock.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xmemory0"
#include "dev/silverware/git/sdk/agmemorystream.h"
#include "dev/silverware/git/sdk/agmemorypool.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/stdio.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wstdio.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_new.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_stdio_config.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/thread"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/time.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/memory"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/wchar.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wconio.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/mutex"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/chrono"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_exception.h"
#include "dev/silverware/git/sdk/system/agsysteminfo.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/limits"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wtime.h"
#include "dev/silverware/git/src/platforms/pc/sdl/include/sdl_endian.h"
#include "dev/silverware/git/sdk/agvector2.h"
#include "dev/silverware/git/src/platforms/shared/input/agsdlgamepadcontroller.h"
#include "dev/silverware/git/sdk/agmath.h"
#include "dev/silverware/git/src/platforms/pc/sdl/include/sdl_rect.h"
#include "dev/silverware/git/sdk/input/agcontroller.h"
#include "dev/silverware/git/sdk/agreferencedobjectinl.h"
#include "dev/silverware/git/sdk/system/aguser.h"
#include "dev/silverware/git/sdk/agpointer.h"
#include "dev/silverware/git/sdk/agreferencedobject.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vadefs.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xfacet"
#include "dev/silverware/git/sdk/platforms/pc/system/agpcsysteminfo.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/list"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xmemory"
#include "dev/silverware/git/sdk/agstring.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtgmath.h"

std::piecewise_construct_t std::piecewise_construct; // 0x140871C50
typedef short AgInt16;
AgSDLGamepadController::AgSDLGamepadController(unsigned long id, _SDL_GameController * gameController); // 0x14069EE20
AgSDLGamepadController::~AgSDLGamepadController(); // 0x14069F0B0
void AgSDLGamepadController::update(); // 0x14069F230
void AgSDLGamepadController::clear(); // 0x14069F180
AgString AgSDLGamepadController::getMappingString(); // 0x14069F1D0//decompilation failure at 140871C50!
void __fastcall AgControllerRumbleComponent::AgControllerRumbleComponent(
        AgControllerRumbleComponent *this,
        unsigned int id)
{
  int v3; // edi
  AgStringRef *v4; // rax
  AgPCSystemConfig *SystemConfig; // rax
  AgJsonNode *Child; // rax
  AgStringRef v7; // [rsp+30h] [rbp-58h] BYREF
  AgStringRef v8; // [rsp+40h] [rbp-48h] BYREF
  void **v9; // [rsp+50h] [rbp-38h]
  AgPointer<AgJsonNodeData> v10; // [rsp+58h] [rbp-30h] BYREF
  AgJsonNode v11; // [rsp+68h] [rbp-20h] BYREF

  this->m_type = AgControllerComponentType_Rumble;
  this->m_id = id;
  v3 = 0;
  *(_QWORD *)&this->m_value = 0i64;
  if ( AgSystemManager::getSystemConfig()->m_configJson.m_data.m_ptr->m_type == AgJsonNodeType_Null )
  {
    this->m_enabled = 1;
  }
  else
  {
    AgStringRef::AgStringRef(&v8, "vibration");
    v7 = *v4;
    SystemConfig = AgSystemManager::getSystemConfig();
    Child = AgJsonObject::getChild(&SystemConfig->m_configJson, &v11, &v7);
    v9 = &AgJsonNode::`vftable';
    v10 = 0i64;
    if ( Child->m_data.m_ptr->m_type )
      Child = AgJsonNode::Null();
    AgPointer<AgJsonNodeData>::operator=(&v10, &Child->m_data);
    v9 = &AgJsonValue::`vftable';
    v11.__vftable = (AgJsonNode_vtbl *)&AgJsonNode::`vftable';
    AgPointer<AgJsonNodeData>::~AgPointer<AgJsonNodeData>(&v11.m_data);
    if ( v10.m_ptr->m_type == AgJsonNodeType_Null )
    {
      this->m_enabled = 1;
    }
    else
    {
      LOBYTE(v3) = *(double *)&v10.m_ptr[1].m_type > 0.0;
      this->m_enabled = v3;
    }
    v9 = &AgJsonNode::`vftable';
    AgPointer<AgJsonNodeData>::~AgPointer<AgJsonNodeData>(&v10);
  }
}

void __fastcall AgSDLGamepadController::AgSDLGamepadController(
        AgSDLGamepadController *this,
        unsigned int id,
        _SDL_GameController *gameController)
{
  _SDL_Joystick *Joystick_0; // rbx
  _SDL_Haptic *v6; // rax
  int HardwareType; // eax
  AgControllerHardwareType v8; // ebx
  const char *v9; // rdx
  __int64 v10; // rax
  AgStringRef *v11; // rax
  AgStringRef copy; // [rsp+30h] [rbp-48h] BYREF
  AgStringRef v13; // [rsp+40h] [rbp-38h] BYREF

  AgController::AgController(this, AgControllerType_Gamepad, id);
  this->__vftable = (AgSDLGamepadController_vtbl *)&AgSDLGamepadController::`vftable';
  AgControllerButtonComponent::AgControllerButtonComponent(&this->m_buttons);
  this->m_leftStickX.m_type = AgControllerComponentType_Axis;
  *(_QWORD *)&this->m_leftStickX.m_id = 4i64;
  this->m_leftStickY.m_type = AgControllerComponentType_Axis;
  *(_QWORD *)&this->m_leftStickY.m_id = 5i64;
  this->m_leftTrigger.m_type = AgControllerComponentType_Axis;
  *(_QWORD *)&this->m_leftTrigger.m_id = 6i64;
  this->m_rightStickX.m_type = AgControllerComponentType_Axis;
  *(_QWORD *)&this->m_rightStickX.m_id = 7i64;
  this->m_rightStickY.m_type = AgControllerComponentType_Axis;
  *(_QWORD *)&this->m_rightStickY.m_id = 8i64;
  this->m_rightTrigger.m_type = AgControllerComponentType_Axis;
  *(_QWORD *)&this->m_rightTrigger.m_id = 9i64;
  AgControllerRumbleComponent::AgControllerRumbleComponent(&this->m_rumble, 0);
  this->m_gameController = gameController;
  this->m_haptic = 0i64;
  *(_QWORD *)&this->m_rumblePlaying = 0i64;
  std::vector<bool>::resize(&this->m_buttons.m_buttons, 0xFui64, 0);
  std::vector<bool>::resize(&this->m_buttons.m_lastButtons, 0xFui64, 0);
  AgController::addComponent(this, &this->m_buttons);
  AgController::addComponent(this, &this->m_leftStickX);
  AgController::addComponent(this, &this->m_leftStickY);
  AgController::addComponent(this, &this->m_leftTrigger);
  AgController::addComponent(this, &this->m_rightStickX);
  AgController::addComponent(this, &this->m_rightStickY);
  AgController::addComponent(this, &this->m_rightTrigger);
  AgController::addComponent(this, &this->m_rumble);
  Joystick_0 = (_SDL_Joystick *)SDL_GameControllerGetJoystick_0(this->m_gameController);
  v6 = (_SDL_Haptic *)SDL_HapticOpenFromJoystick_0(Joystick_0);
  this->m_haptic = v6;
  if ( v6 && (unsigned int)SDL_HapticRumbleInit_0(v6) )
  {
    SDL_HapticClose_0(this->m_haptic);
    this->m_haptic = 0i64;
  }
  HardwareType = AgSDLInputManager::getHardwareType(Joystick_0, &this->m_uid);
  v8 = HardwareType;
  if ( HardwareType <= 0 )
    goto LABEL_11;
  if ( HardwareType <= 2 )
  {
    v9 = "$XBOX_CONTROLLER_NAME";
    goto LABEL_13;
  }
  if ( HardwareType == 3 )
  {
    v9 = "$PS3_CONTROLLER_NAME";
    goto LABEL_13;
  }
  if ( HardwareType == 4 )
  {
    v9 = "$PS4_CONTROLLER_NAME";
  }
  else
  {
LABEL_11:
    v10 = SDL_GameControllerName_0(this->m_gameController);
    v9 = "$GENERIC_CONTROLLER_NAME";
    if ( v10 )
      v9 = (const char *)v10;
  }
LABEL_13:
  AgStringRef::AgStringRef(&v13, v9);
  copy = *v11;
  AgString::operator=(&this->m_name, &copy);
  this->m_hardwareType = v8;
}

void __fastcall AgSDLGamepadController::~AgSDLGamepadController(AgSDLGamepadController *this)
{
  _SDL_Haptic *m_haptic; // rcx
  unsigned __int64 v3; // rdx
  std::map<enum AgControllerComponentType,std::list<AgControllerComponent *>> *p_m_components; // rbx
  std::_Tree_iterator<std::_Tree_val<std::_Tree_simple_types<std::pair<enum AgControllerComponentType const ,std::list<AgControllerComponent *> > > > > result; // [rsp+48h] [rbp+10h] BYREF

  this->__vftable = (AgSDLGamepadController_vtbl *)&AgSDLGamepadController::`vftable';
  SDL_GameControllerClose_0(this->m_gameController);
  m_haptic = this->m_haptic;
  if ( m_haptic )
    SDL_HapticClose_0(m_haptic);
  AgControllerButtonComponent::~AgControllerButtonComponent(&this->m_buttons);
  this->__vftable = (AgSDLGamepadController_vtbl *)&AgController::`vftable';
  AgString::~AgString(&this->m_name, v3);
  p_m_components = &this->m_components;
  std::_Tree<std::_Tmap_traits<enum AgControllerComponentType,std::list<AgControllerComponent *>,std::less<enum AgControllerComponentType>,std::allocator<std::pair<enum AgControllerComponentType const,std::list<AgControllerComponent *>>>,0>>::erase(
    p_m_components,
    &result,
    (std::_Tree_const_iterator<std::_Tree_val<std::_Tree_simple_types<std::pair<enum AgControllerComponentType const ,std::list<AgControllerComponent *> > > > >)p_m_components->_Mypair._Myval2._Myval2._Myhead->_Left,
    (std::_Tree_const_iterator<std::_Tree_val<std::_Tree_simple_types<std::pair<enum AgControllerComponentType const ,std::list<AgControllerComponent *> > > > >)p_m_components->_Mypair._Myval2._Myval2._Myhead);
  operator delete(p_m_components->_Mypair._Myval2._Myval2._Myhead);
}

void __fastcall AgSDLJoystickController::clear(AgSDLJoystickController *this)
{
  AgControllerButtonComponent::clear(&this->m_buttons);
  this->m_leftStickX.m_value = 0.0;
  this->m_leftStickY.m_value = 0.0;
  this->m_leftTrigger.m_value = 0.0;
  this->m_rightStickX.m_value = 0.0;
  this->m_rightStickY.m_value = 0.0;
  this->m_rightTrigger.m_value = 0.0;
  this->m_rumble.m_value = 0.0;
}

AgString *__fastcall AgSDLGamepadController::getMappingString(AgSDLGamepadController *this, AgString *result)
{
  const char *v3; // rbx

  v3 = (const char *)SDL_GameControllerMapping_0(this->m_gameController);
  AgString::AgString(result, v3, -1);
  SDL_free_0(v3);
  return result;
}

AgControllerUID __fastcall AgSDLJoystickController::getUID(AgSDLJoystickController *this, AgControllerUID *a2)
{
  *a2 = this->m_uid;
  return (AgControllerUID)a2;
}

void __fastcall AgSDLGamepadController::update(AgSDLGamepadController *this)
{
  std::vector<bool> *p_m_buttons; // rdx
  std::vector<bool> *p_m_lastButtons; // rcx
  unsigned int m_duration; // ebp
  const SDL_GameControllerButton *v5; // rsi
  int i; // ebx
  char Button_0; // al
  unsigned int *Myfirst; // r8
  unsigned __int64 v9; // rcx
  char v10; // dl
  bool v11; // zf
  unsigned int v12; // eax
  AgSingleton<AgInputManager>_vtbl *v13; // rcx
  int Axis_0; // ebx
  __int16 v15; // ax
  float m_x; // xmm10_4
  float v17; // xmm3_4
  float v18; // xmm2_4
  float v19; // xmm7_4
  float v20; // xmm2_4
  float m_y; // xmm3_4
  float v22; // xmm7_4
  float m_value; // xmm8_4
  float v24; // xmm10_4
  float v25; // xmm7_4
  int v26; // ebx
  __int16 v27; // ax
  float v28; // xmm9_4
  float v29; // xmm3_4
  float v30; // xmm2_4
  float v31; // xmm6_4
  float v32; // xmm2_4
  float v33; // xmm3_4
  float v34; // xmm6_4
  float v35; // xmm9_4
  float v36; // xmm6_4
  float v37; // xmm0_4
  AgSingleton<AgInputManager> *v38; // rdx
  float v39; // xmm0_4
  AgSingleton<AgInputManager>_vtbl *v40; // rcx
  float v41; // xmm0_4

  p_m_buttons = &this->m_buttons.m_buttons;
  p_m_lastButtons = &this->m_buttons.m_lastButtons;
  p_m_lastButtons->_Mysize = p_m_buttons->_Mysize;
  std::vector<unsigned int>::operator=(&p_m_lastButtons->_Myvec, &p_m_buttons->_Myvec);
  m_duration = 0;
  v5 = buttonMapping;
  for ( i = 0; i < 15; ++i )
  {
    Button_0 = SDL_GameControllerGetButton_0(this->m_gameController, *(unsigned int *)v5);
    Myfirst = this->m_buttons.m_buttons._Myvec._Mypair._Myval2._Myfirst;
    v9 = (unsigned __int64)(unsigned __int16)i >> 5;
    v10 = i & 0x1F;
    v11 = Button_0 == 0;
    v12 = Myfirst[v9];
    if ( v11 )
    {
      Myfirst[v9] = v12 & ~(1 << v10);
    }
    else
    {
      Myfirst[v9] = v12 | (1 << v10);
      v13 = AgSingleton<AgInputManager>::ms_instance[15].__vftable;
      AgSingleton<AgInputManager>::ms_instance[15].__vftable = (AgSingleton<AgInputManager>_vtbl *)((char *)&v13->~AgSingleton<AgInputManager>
                                                                                                  + 1);
      this->m_lastUsed = (unsigned __int64)v13;
    }
    ++v5;
  }
  Axis_0 = (__int16)SDL_GameControllerGetAxis_0(this->m_gameController, 1i64);
  v15 = SDL_GameControllerGetAxis_0(this->m_gameController, 0i64);
  m_x = AgVector2::Zero.m_x;
  v17 = (float)Axis_0 * 0.000030518509;
  v18 = (float)v15 * 0.000030518509;
  v19 = fsqrt((float)(v17 * v17) + (float)(v18 * v18));
  if ( v19 >= 0.00000011920929 )
  {
    v20 = v18 * (float)(1.0 / v19);
    m_y = v17 * (float)(1.0 / v19);
  }
  else
  {
    v20 = AgVector2::Zero.m_x;
    m_y = AgVector2::Zero.m_y;
  }
  v22 = v19 - 0.25;
  m_value = 0.0;
  if ( v22 <= 0.0 )
  {
    v25 = AgVector2::Zero.m_y;
  }
  else
  {
    v24 = fminf(v22 * 1.3333334, 1.0);
    v25 = v24 * m_y;
    m_x = v24 * v20;
  }
  v26 = (__int16)SDL_GameControllerGetAxis_0(this->m_gameController, 3i64);
  v27 = SDL_GameControllerGetAxis_0(this->m_gameController, 2i64);
  v28 = AgVector2::Zero.m_x;
  v29 = (float)v26 * 0.000030518509;
  v30 = (float)v27 * 0.000030518509;
  v31 = fsqrt((float)(v29 * v29) + (float)(v30 * v30));
  if ( v31 >= 0.00000011920929 )
  {
    v32 = v30 * (float)(1.0 / v31);
    v33 = v29 * (float)(1.0 / v31);
  }
  else
  {
    v32 = AgVector2::Zero.m_x;
    v33 = AgVector2::Zero.m_y;
  }
  v34 = v31 - 0.25;
  if ( v34 <= 0.0 )
  {
    v36 = AgVector2::Zero.m_y;
  }
  else
  {
    v35 = fminf(v34 * 1.3333334, 1.0);
    v36 = v35 * v33;
    v28 = v35 * v32;
  }
  if ( this->m_leftStickX.m_type )
    this->m_leftStickX.m_value = m_x;
  if ( this->m_leftStickY.m_type )
    this->m_leftStickY.m_value = v25;
  if ( this->m_rightStickX.m_type )
    this->m_rightStickX.m_value = v28;
  if ( this->m_rightStickY.m_type )
    this->m_rightStickY.m_value = v36;
  v37 = (float)(__int16)SDL_GameControllerGetAxis_0(this->m_gameController, 4i64) * 0.000030518509;
  if ( this->m_leftTrigger.m_type )
    this->m_leftTrigger.m_value = v37;
  v39 = (float)(__int16)SDL_GameControllerGetAxis_0(this->m_gameController, 5i64) * 0.000030518509;
  if ( this->m_rightTrigger.m_type )
    this->m_rightTrigger.m_value = v39;
  if ( (float)((float)(v25 * v25) + (float)(m_x * m_x)) > 0.0
    || (float)((float)(v36 * v36) + (float)(v28 * v28)) > 0.0
    || this->m_leftTrigger.m_type && this->m_leftTrigger.m_value > 0.0
    || this->m_rightTrigger.m_type && this->m_rightTrigger.m_value > 0.0 )
  {
    v38 = AgSingleton<AgInputManager>::ms_instance;
    v40 = AgSingleton<AgInputManager>::ms_instance[15].__vftable;
    AgSingleton<AgInputManager>::ms_instance[15].__vftable = (AgSingleton<AgInputManager>_vtbl *)((char *)&v40->~AgSingleton<AgInputManager>
                                                                                                + 1);
    this->m_lastUsed = (unsigned __int64)v40;
  }
  if ( this->m_haptic )
  {
    v41 = this->m_rumble.m_type ? this->m_rumble.m_value : 0.0;
    if ( v41 != this->m_rumbleValue )
    {
      if ( this->m_rumblePlaying == 1 )
        SDL_HapticRumbleStop_0();
      if ( this->m_rumble.m_type && this->m_rumble.m_value > 0.0 )
      {
        if ( this->m_rumble.m_type )
          m_duration = this->m_rumble.m_duration;
        if ( m_duration == -1 )
          m_duration = -1;
        SDL_HapticRumblePlay_0(this->m_haptic, v38, m_duration);
        this->m_rumblePlaying = 1;
      }
      else
      {
        this->m_rumblePlaying = 0;
      }
      if ( this->m_rumble.m_type )
        m_value = this->m_rumble.m_value;
      this->m_rumbleValue = m_value;
    }
  }
}

