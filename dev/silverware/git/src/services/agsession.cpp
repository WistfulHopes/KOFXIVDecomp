#include "program files (x86)/microsoft visual studio 14.0/vc/include/vector"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtgmath.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtr1common"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/stdlib.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xstddef"
#include "dev/silverware/git/sdk/agreferencecountinl.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/mutex"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/chrono"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/limits"
#include "dev/silverware/git/sdk/system/agsysteminfo.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/time.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/thread"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/utility"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/memory"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xmemory"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/thr/xthread"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/iosfwd"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/stdio.h"
#include "dev/silverware/git/sdk/util/agdelegate.h"
#include "dev/silverware/git/sdk/agpointerinl.h"
#include "dev/silverware/git/sdk/platforms/pc/system/agpcsysteminfo.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/type_traits"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/map"
#include "dev/silverware/git/sdk/input/agcontrollerbuttoncomponent.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xtree"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xfacet"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wconio.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_stdio_config.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xatomic0.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/list"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/functional"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xstring"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xmemory0"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/exception"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/malloc.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_new.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/cmath"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wstring.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/math.h"
#include "dev/silverware/git/sdk/system/agsystemmanager.h"
#include "dev/silverware/git/sdk/system/agsystemconfig.h"
#include "dev/silverware/git/sdk/util/agdebugchannels.h"
#include "dev/silverware/git/sdk/util/agperformancecounter.h"
#include "dev/silverware/git/sdk/agclock.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wstdio.h"
#include "dev/silverware/git/sdk/agreferenceinl.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/sys/stat.h"
#include "dev/silverware/git/sdk/system/agplayermanager.h"
#include "dev/silverware/git/sdk/system/agplayer.h"
#include "dev/silverware/git/sdk/input/agcontroller.h"
#include "dev/silverware/git/sdk/input/agcontrollercomponent.h"
#include "dev/silverware/git/sdk/agreferencedobjectinl.h"
#include "dev/silverware/git/sdk/agsingleton.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_typeinfo.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xutility"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/wchar.h"
#include "dev/silverware/git/sdk/agstring.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_memcpy_s.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/string"
#include "dev/silverware/git/sdk/util/agjsondata.h"
#include "dev/silverware/git/sdk/agstream.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/ios"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocnum"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/string.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xiosbase"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_memory.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocale"
#include "dev/silverware/git/sdk/system/aguser.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/xlocinfo"
#include "dev/silverware/git/sdk/agpointer.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/ctype.h"
#include "dev/silverware/git/sdk/agreferencedobject.h"
#include "dev/silverware/git/sdk/agreferencecount.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vcruntime_exception.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wtime.h"
#include "program files (x86)/windows kits/10/include/10.0.10240.0/ucrt/corecrt_wio.h"
#include "dev/silverware/git/sdk/services/agsessionmanager.h"
#include "dev/silverware/git/sdk/services/agsession.h"
#include "dev/silverware/git/sdk/system/agusermanager.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/system_error"
#include "dev/silverware/git/sdk/util/ageventdispatcher.h"
#include "dev/silverware/git/sdk/agmutex.inl"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/stdexcept"
#include "dev/silverware/git/sdk/agmutex.h"
#include "dev/silverware/git/sdk/agscopedlock.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/vadefs.h"
#include "program files (x86)/microsoft visual studio 14.0/vc/include/tuple"

std::piecewise_construct_t std::piecewise_construct; // 0x140872670
AgSession::AgSession(const AgString & name); // 0x1406A1790
AgSession::~AgSession(); // 0x1406A1920
long AgSession::remove(AgPointer<AgUser> user); // 0x1406A20A0
long AgSession::start(); // 0x1406A21E0
long AgSession::stop(); // 0x1406A2460
void AgSession::startUser(AgPointer<AgUser> user); // 0x1406A2400
void AgSession::pauseUser(AgPointer<AgUser> user); // 0x1406A1FC0
void AgSession::stopUser(AgPointer<AgUser> user); // 0x1406A25A0
long AgSession::isValid(); // 0x1406A1BC0
void AgSession::onUserRemoved(const AgUserRemovedEvent & e); // 0x1406A1EC0
void AgSession::onSuspending(const AgSuspendingEvent & e); // 0x1406A1EB0
void AgSession::onResuming(const AgResumingEvent & e); // 0x1406A1E90//decompilation failure at 140872670!
void __fastcall std::_Destroy_range<std::allocator<AgPointer<AgSession>>,AgPointer<AgSession> *>(
        AgPointer<AgSession> *_First,
        AgPointer<AgSession> *_Last,
        std::_Wrap_alloc<std::allocator<AgPointer<AgSession> > > *_Al)
{
  AgPointer<AgSession> *v4; // rbx

  if ( _First != _Last )
  {
    v4 = _First;
    do
      AgPointer<AgSession>::~AgPointer<AgSession>(v4++);
    while ( v4 != _Last );
  }
}

AgPointer<AgUser> *__fastcall std::_Move_unchecked1<AgPointer<AgUser> *,AgPointer<AgUser> *>(
        AgPointer<AgUser> *_First,
        AgPointer<AgUser> *_Last,
        AgPointer<AgUser> *_Dest,
        std::_General_ptr_iterator_tag __formal)
{
  AgPointer<AgUser> *i; // rbx
  AgReferenceCount *m_ref; // r9
  AgUser *m_ptr; // rax
  AgReferenceCount *v9; // rdi
  AgUser *v10; // r14
  int v11; // ebp

  for ( i = _First; i != _Last; ++i )
  {
    m_ref = i->m_ref;
    m_ptr = i->m_ptr;
    i->m_ref = 0i64;
    i->m_ptr = 0i64;
    v9 = _Dest->m_ref;
    v10 = _Dest->m_ptr;
    _Dest->m_ref = m_ref;
    _Dest->m_ptr = m_ptr;
    if ( v9 )
    {
      v11 = 0;
      if ( !(unsigned int)AgAtomicDecrement(&v9->m_strongCount) )
      {
        if ( !(unsigned int)AgAtomicDecrement(&v9->m_weakCount) )
          v11 = 1;
        v9->m_data = 0i64;
        if ( v10 )
          ((void (__fastcall *)(AgUser *, __int64))v10->~AgUser)(v10, 1i64);
        if ( v11 )
          AgReferenceCount::operator delete(v9);
      }
    }
    ++_Dest;
  }
  return _Dest;
}

AgPointer<AgSession> *__fastcall std::_Uninitialized_move_al_unchecked1<AgPointer<AgSession> *,AgPointer<AgSession> *,std::allocator<AgPointer<AgSession>>>(
        AgPointer<AgSession> *_First,
        AgPointer<AgSession> *_Last,
        AgPointer<AgSession> *_Dest,
        std::_Wrap_alloc<std::allocator<AgPointer<AgSession> > > *_Al)
{
  while ( _First != _Last )
  {
    if ( _Dest )
    {
      *_Dest = *_First;
      _First->m_ref = 0i64;
      _First->m_ptr = 0i64;
    }
    ++_Dest;
    ++_First;
  }
  return _Dest;
}

void __fastcall AgSession::AgSession(AgSession *this, const AgString *name)
{
  AgSingleton<AgUserManager> *v3; // rbx
  detail::GenericClass *v4; // rax
  AgSingleton<AgSystemManager> *v5; // rbx
  detail::GenericClass *v6; // rax
  AgSingleton<AgSystemManager> *v7; // rbx
  detail::GenericClass *v8; // rax
  AgDelegate1<AgUserRemovedEvent const &,void> _Val; // [rsp+58h] [rbp-20h] BYREF

  this->m_refCount = 0i64;
  this->__vftable = (AgSession_vtbl *)&AgSession::`vftable';
  AgString::AgString(&this->m_name, name);
  this->m_users._Mypair._Myval2._Myfirst = 0i64;
  this->m_users._Mypair._Myval2._Mylast = 0i64;
  this->m_users._Mypair._Myval2._Myend = 0i64;
  *(_QWORD *)&this->m_started = 0i64;
  this->m_wasStarted = 0;
  InitializeCriticalSection((LPCRITICAL_SECTION)&this->m_mutex);
  Scaleform::Render::SubImage::GetAsImage((std::_Wrap_alloc<std::allocator<AgString> > *)this);
  v3 = AgSingleton<AgUserManager>::ms_instance + 24;
  _Val.m_Closure.m_pFunction = (void (__fastcall *)(detail::GenericClass *))AgSession::onUserRemoved;
  _Val.m_Closure.m_pthis = v4;
  EnterCriticalSection((LPCRITICAL_SECTION)&AgSingleton<AgUserManager>::ms_instance[24]);
  std::vector<AgDelegate1<AgUserRemovedEvent const &,void>>::push_back(
    (std::vector<AgDelegate1<AgUserRemovedEvent const &,void>> *)&v3[5],
    &_Val);
  LeaveCriticalSection((LPCRITICAL_SECTION)v3);
  Scaleform::Render::SubImage::GetAsImage((std::_Wrap_alloc<std::allocator<AgString> > *)this);
  v5 = AgSingleton<AgSystemManager>::ms_instance + 33;
  _Val.m_Closure.m_pFunction = (void (__fastcall *)(detail::GenericClass *))AgSession::onSuspending;
  _Val.m_Closure.m_pthis = v6;
  EnterCriticalSection((LPCRITICAL_SECTION)&AgSingleton<AgSystemManager>::ms_instance[33]);
  std::vector<AgDelegate1<AgSuspendingEvent const &,void>>::push_back(
    (std::vector<AgDelegate1<AgSuspendingEvent const &,void>> *)&v5[5],
    (const AgDelegate1<AgSuspendingEvent const &,void> *)&_Val);
  LeaveCriticalSection((LPCRITICAL_SECTION)v5);
  Scaleform::Render::SubImage::GetAsImage((std::_Wrap_alloc<std::allocator<AgString> > *)this);
  v7 = AgSingleton<AgSystemManager>::ms_instance + 49;
  _Val.m_Closure.m_pFunction = (void (__fastcall *)(detail::GenericClass *))AgSession::onResuming;
  _Val.m_Closure.m_pthis = v8;
  EnterCriticalSection((LPCRITICAL_SECTION)&AgSingleton<AgSystemManager>::ms_instance[49]);
  std::vector<AgDelegate1<AgResumingEvent const &,void>>::push_back(
    (std::vector<AgDelegate1<AgResumingEvent const &,void>> *)&v7[5],
    (const AgDelegate1<AgResumingEvent const &,void> *)&_Val);
  LeaveCriticalSection((LPCRITICAL_SECTION)v7);
}

void __fastcall AgSession::~AgSession(AgSession *this)
{
  detail::GenericClass *v2; // rax
  detail::GenericClass *v3; // rax
  detail::GenericClass *v4; // rax
  unsigned __int64 v5; // rdx
  AgDelegate1<AgSuspendingEvent const &,void> v6[2]; // [rsp+28h] [rbp-20h] BYREF

  this->__vftable = (AgSession_vtbl *)&AgSession::`vftable';
  AgSession::stop(this);
  Scaleform::Render::SubImage::GetAsImage((std::_Wrap_alloc<std::allocator<AgString> > *)this);
  v6[0].m_Closure.m_pFunction = (void (__fastcall *)(detail::GenericClass *))AgSession::onUserRemoved;
  v6[0].m_Closure.m_pthis = v2;
  AgEventDispatcherBase<AgUserRemovedEvent>::unbind(
    (AgEventDispatcherBase<AgUserRemovedEvent> *)&AgSingleton<AgUserManager>::ms_instance[24],
    (AgDelegate1<AgUserRemovedEvent const &,void> *)v6);
  Scaleform::Render::SubImage::GetAsImage((std::_Wrap_alloc<std::allocator<AgString> > *)this);
  v6[0].m_Closure.m_pFunction = (void (__fastcall *)(detail::GenericClass *))AgSession::onSuspending;
  v6[0].m_Closure.m_pthis = v3;
  AgEventDispatcherBase<AgSuspendingEvent>::unbind(
    (AgEventDispatcherBase<AgSuspendingEvent> *)&AgSingleton<AgSystemManager>::ms_instance[33],
    v6);
  Scaleform::Render::SubImage::GetAsImage((std::_Wrap_alloc<std::allocator<AgString> > *)this);
  v6[0].m_Closure.m_pFunction = (void (__fastcall *)(detail::GenericClass *))AgSession::onResuming;
  v6[0].m_Closure.m_pthis = v4;
  AgEventDispatcherBase<AgResumingEvent>::unbind(
    (AgEventDispatcherBase<AgResumingEvent> *)&AgSingleton<AgSystemManager>::ms_instance[49],
    (AgDelegate1<AgResumingEvent const &,void> *)v6);
  DeleteCriticalSection((LPCRITICAL_SECTION)&this->m_mutex);
  std::vector<AgPointer<AgThread>>::_Tidy(&this->m_users);
  AgString::~AgString(&this->m_name, v5);
}

void __fastcall std::vector<AgPointer<AgSession>>::_Reallocate(
        std::vector<AgPointer<AgSession>> *this,
        unsigned __int64 _Count)
{
  AgPointer<AgSession> *v4; // r12
  AgPointer<AgSession> *Mylast; // r14
  AgPointer<AgSession> *Myfirst; // rbx
  signed __int64 v7; // rsi

  v4 = (AgPointer<AgSession> *)std::allocator<AgDelegate1<AgShutdownEvent const &,void>>::allocate(
                                 (std::allocator<AgDelegate1<AgShutdownEvent const &,void> > *)this,
                                 _Count);
  std::_Uninitialized_move_al_unchecked1<AgPointer<AgSession> *,AgPointer<AgSession> *,std::allocator<AgPointer<AgSession>>>(
    this->_Mypair._Myval2._Myfirst,
    this->_Mypair._Myval2._Mylast,
    v4,
    (std::_Wrap_alloc<std::allocator<AgPointer<AgSession> > > *)this);
  Mylast = this->_Mypair._Myval2._Mylast;
  Myfirst = this->_Mypair._Myval2._Myfirst;
  v7 = (char *)Mylast - (char *)this->_Mypair._Myval2._Myfirst;
  if ( this->_Mypair._Myval2._Myfirst )
  {
    for ( ; Myfirst != Mylast; ++Myfirst )
      AgPointer<AgSession>::~AgPointer<AgSession>(Myfirst);
    std::_Wrap_alloc<std::allocator<AgDelegate1<AgSuspendingEvent const &,void>>>::deallocate(
      (std::_Wrap_alloc<std::allocator<AgDelegate1<AgUserUpdatedEvent const &,void> > > *)this,
      (AgDelegate1<AgUserUpdatedEvent const &,void> *)this->_Mypair._Myval2._Myfirst,
      this->_Mypair._Myval2._Myend - this->_Mypair._Myval2._Myfirst);
  }
  this->_Mypair._Myval2._Myend = &v4[_Count];
  this->_Mypair._Myval2._Mylast = (AgPointer<AgSession> *)((char *)v4 + (v7 & 0xFFFFFFFFFFFFFFF0ui64));
  this->_Mypair._Myval2._Myfirst = v4;
}

void __fastcall std::vector<AgPointer<AgSession>>::_Reserve(
        std::vector<AgPointer<AgSession>> *this,
        unsigned __int64 _Count)
{
  AgPointer<AgSession> *Myend; // r10
  AgPointer<AgSession> *Mylast; // r8
  AgPointer<AgSession> *Myfirst; // rcx
  __int64 v6; // r8
  unsigned __int64 v7; // rdx
  unsigned __int64 v8; // r10
  unsigned __int64 v9; // rcx

  Myend = this->_Mypair._Myval2._Myend;
  Mylast = this->_Mypair._Myval2._Mylast;
  if ( Myend - Mylast < _Count )
  {
    Myfirst = this->_Mypair._Myval2._Myfirst;
    v6 = Mylast - Myfirst;
    if ( 0xFFFFFFFFFFFFFFFi64 - v6 < _Count )
      std::_Xlength_error("vector<T> too long");
    v7 = v6 + _Count;
    v8 = Myend - Myfirst;
    v9 = 0i64;
    if ( 0xFFFFFFFFFFFFFFFi64 - (v8 >> 1) >= v8 )
      v9 = v8 + (v8 >> 1);
    if ( v9 >= v7 )
      v7 = v9;
    std::vector<AgPointer<AgSession>>::_Reallocate(this, v7);
  }
}

AgDelegate1<AgShutdownEvent const &,void> *__fastcall std::allocator<AgDelegate1<AgShutdownEvent const &,void>>::allocate(
        std::allocator<AgDelegate1<AgShutdownEvent const &,void> > *this,
        unsigned __int64 _Count)
{
  AgDelegate1<AgShutdownEvent const &,void> *result; // rax
  unsigned __int64 v3; // rdx
  void (__fastcall *v4)(detail::GenericClass *); // rax
  void (__fastcall *v5)(detail::GenericClass *); // rcx

  if ( !_Count )
    return 0i64;
  if ( _Count > 0xFFFFFFFFFFFFFFFi64 )
    std::_Xbad_alloc();
  v3 = 16 * _Count;
  if ( v3 < 0x1000 )
  {
    result = (AgDelegate1<AgShutdownEvent const &,void> *)operator new(v3);
    if ( !result )
      invalid_parameter_noinfo_noreturn();
  }
  else
  {
    if ( v3 + 39 <= v3 )
      std::_Xbad_alloc();
    v4 = (void (__fastcall *)(detail::GenericClass *))operator new(v3 + 39);
    v5 = v4;
    if ( !v4 )
      invalid_parameter_noinfo_noreturn();
    result = (AgDelegate1<AgShutdownEvent const &,void> *)(((unsigned __int64)v4 + 39) & 0xFFFFFFFFFFFFFFE0ui64);
    result[-1].m_Closure.m_pFunction = v5;
  }
  return result;
}

_BOOL8 __fastcall AgSession::isValid(AgSession *this)
{
  AgMutex *p_m_mutex; // rbx
  unsigned int v3; // er12
  __int64 v4; // rsi
  AgPointer<AgUser> *v5; // rsi
  volatile int *p_m_strongCount; // rdi
  int v7; // ebx
  AgUser *m_ptr; // rbp
  AgUser *v9; // rdi
  AgReferenceCount *m_ref; // rbx
  int v11; // esi
  int v12; // esi
  int v13; // esi
  BOOL v14; // edi
  AgPointer<AgUser> value; // [rsp+28h] [rbp-60h]
  AgMutex *lpCriticalSection; // [rsp+40h] [rbp-48h]
  AgPointer<AgUser> result; // [rsp+48h] [rbp-40h] BYREF

  p_m_mutex = &this->m_mutex;
  lpCriticalSection = &this->m_mutex;
  EnterCriticalSection((LPCRITICAL_SECTION)&this->m_mutex);
  v3 = 0;
  if ( this->m_users._Mypair._Myval2._Mylast - this->m_users._Mypair._Myval2._Myfirst )
  {
    v4 = 0i64;
    while ( 1 )
    {
      v5 = &this->m_users._Mypair._Myval2._Myfirst[v4];
      value = 0i64;
      p_m_strongCount = &v5->m_ref->m_strongCount;
      if ( v5->m_ref )
      {
        v7 = *p_m_strongCount;
        if ( *p_m_strongCount )
        {
          while ( (unsigned int)AgAtomicCompareExchange(p_m_strongCount, v7, v7 + 1) != v7 )
          {
            v7 = *p_m_strongCount;
            if ( !*p_m_strongCount )
              goto LABEL_10;
          }
          if ( v7 != -1 )
            value = *v5;
        }
      }
LABEL_10:
      m_ptr = AgUserManager::getUser(
                (AgUserManager *)AgSingleton<AgUserManager>::ms_instance,
                &result,
                value.m_ptr->m_id)->m_ptr;
      v9 = result.m_ptr;
      result.m_ptr = 0i64;
      m_ref = result.m_ref;
      if ( result.m_ref )
      {
        result.m_ref = 0i64;
        v11 = 0;
        if ( !(unsigned int)AgAtomicDecrement(&m_ref->m_strongCount) )
        {
          if ( !(unsigned int)AgAtomicDecrement(&m_ref->m_weakCount) )
            v11 = 1;
          m_ref->m_data = 0i64;
          if ( v9 )
            ((void (__fastcall *)(AgUser *, __int64))v9->~AgUser)(v9, 1i64);
          if ( v11 )
            AgReferenceCount::operator delete(m_ref);
        }
      }
      if ( !m_ptr )
        break;
      if ( value.m_ref )
      {
        v12 = 0;
        if ( !(unsigned int)AgAtomicDecrement(&value.m_ref->m_strongCount) )
        {
          if ( !(unsigned int)AgAtomicDecrement(&value.m_ref->m_weakCount) )
            v12 = 1;
          value.m_ref->m_data = 0i64;
          if ( value.m_ptr )
            ((void (__fastcall *)(AgUser *, __int64))value.m_ptr->~AgUser)(value.m_ptr, 1i64);
          if ( v12 )
            AgReferenceCount::operator delete(value.m_ref);
        }
      }
      v4 = ++v3;
      if ( v3 >= (unsigned __int64)(this->m_users._Mypair._Myval2._Mylast - this->m_users._Mypair._Myval2._Myfirst) )
      {
        p_m_mutex = lpCriticalSection;
        goto LABEL_38;
      }
    }
    if ( value.m_ref )
    {
      v13 = 0;
      if ( !(unsigned int)AgAtomicDecrement(&value.m_ref->m_strongCount) )
      {
        if ( !(unsigned int)AgAtomicDecrement(&value.m_ref->m_weakCount) )
          v13 = 1;
        value.m_ref->m_data = 0i64;
        if ( value.m_ptr )
          ((void (__fastcall *)(AgUser *, __int64))value.m_ptr->~AgUser)(value.m_ptr, 1i64);
        if ( v13 )
          AgReferenceCount::operator delete(value.m_ref);
      }
    }
    v14 = 0;
    p_m_mutex = lpCriticalSection;
  }
  else
  {
LABEL_38:
    v14 = this->m_users._Mypair._Myval2._Mylast - this->m_users._Mypair._Myval2._Myfirst != 0;
  }
  LeaveCriticalSection((LPCRITICAL_SECTION)p_m_mutex);
  return v14;
}

void __fastcall AgPlayer::lock(AgPlayer *this)
{
  AgMutex *p_m_mutex; // rbx

  p_m_mutex = &this->m_mutex;
  EnterCriticalSection((LPCRITICAL_SECTION)&this->m_mutex);
  this->m_locked = 1;
  LeaveCriticalSection((LPCRITICAL_SECTION)p_m_mutex);
}

void __fastcall AgSession::onResuming(AgSession *this, const AgResumingEvent *e)
{
  if ( this->m_wasStarted )
  {
    this->m_wasStarted = 0;
    AgSession::start(this);
  }
}

void __fastcall AgSession::onSuspending(AgSession *this, const AgSuspendingEvent *e)
{
  this->m_wasStarted = this->m_started;
  AgSession::stop(this);
}

void __fastcall AgSession::onUserRemoved(AgSession *this, const AgUserRemovedEvent *e)
{
  AgPointer<AgUser> *v3; // rax
  AgReferenceCount *v4; // rax
  int v5; // eax
  AgReferenceCount *m_refCount; // rdi
  AgSingleton<AgSessionManager> *v7; // rbx
  _RTL_CRITICAL_SECTION *v8; // rdi
  AgPointer<AgSession> _Val; // [rsp+28h] [rbp-40h] BYREF
  int v10; // [rsp+38h] [rbp-30h]
  AgSingleton<AgSessionManager> *v11; // [rsp+40h] [rbp-28h]
  AgPointer<AgPlayer> v12; // [rsp+48h] [rbp-20h] BYREF

  AgPointer<AgBuffer<AgAllocator<1>>>::AgPointer<AgBuffer<AgAllocator<1>>>(&v12, (const AgPointer<AgPlayer> *)e);
  AgSession::remove(this, v3);
  if ( !this->isValid(this) )
  {
    _Val = 0i64;
    if ( this->m_refCount )
    {
      v5 = 0;
    }
    else
    {
      v4 = (AgReferenceCount *)AgReferenceCount::operator new(0x10ui64);
      if ( v4 )
      {
        v4->m_strongCount = 1;
        v4->m_weakCount = 1;
        v4->m_data = this;
      }
      this->m_refCount = v4;
      v5 = 1;
    }
    m_refCount = this->m_refCount;
    if ( !v5 )
      AgReferenceCount::incRef(this->m_refCount);
    _Val.m_ref = m_refCount;
    _Val.m_ptr = this;
    v7 = AgSingleton<AgSessionManager>::ms_instance;
    v8 = (_RTL_CRITICAL_SECTION *)&AgSingleton<AgSessionManager>::ms_instance[9];
    v11 = AgSingleton<AgSessionManager>::ms_instance + 9;
    EnterCriticalSection((LPCRITICAL_SECTION)&AgSingleton<AgSessionManager>::ms_instance[9]);
    v10 = 1;
    std::vector<AgPointer<AgSession>>::push_back((std::vector<AgPointer<AgSession>> *)&v7[14], &_Val);
    LeaveCriticalSection(v8);
    v10 = 0;
    AgPointer<AgSession>::~AgPointer<AgSession>(&_Val);
  }
}

void __fastcall AgSession::pauseUser(AgSession *this, AgPointer<AgUser> *user)
{
  AgPointer<AgUser>::~AgPointer<AgUser>((AgPointer<KOFApplication> *)user);
}

void __fastcall std::vector<AgPointer<AgSession>>::push_back(
        std::vector<AgPointer<AgSession>> *this,
        AgPointer<AgSession> *_Val)
{
  AgPointer<AgSession> *Mylast; // rax
  AgPointer<AgSession> *Myfirst; // rcx
  signed __int64 v6; // rdi
  AgPointer<AgSession> *v7; // rcx
  AgReferenceCount **v8; // rdi
  AgPointer<AgSession> *v9; // rcx

  Mylast = this->_Mypair._Myval2._Mylast;
  if ( _Val >= Mylast || (Myfirst = this->_Mypair._Myval2._Myfirst, Myfirst > _Val) )
  {
    if ( Mylast == this->_Mypair._Myval2._Myend )
      std::vector<AgPointer<AgSession>>::_Reserve(this, 1ui64);
    v9 = this->_Mypair._Myval2._Mylast;
    if ( v9 )
    {
      v9->m_ref = _Val->m_ref;
      v9->m_ptr = _Val->m_ptr;
      _Val->m_ref = 0i64;
      _Val->m_ptr = 0i64;
    }
  }
  else
  {
    v6 = (char *)_Val - (char *)Myfirst;
    if ( Mylast == this->_Mypair._Myval2._Myend )
      std::vector<AgPointer<AgSession>>::_Reserve(this, 1ui64);
    v7 = this->_Mypair._Myval2._Mylast;
    v8 = (AgReferenceCount **)((char *)&this->_Mypair._Myval2._Myfirst->m_ref + (v6 & 0xFFFFFFFFFFFFFFF0ui64));
    if ( v7 )
    {
      v7->m_ref = *v8;
      v7->m_ptr = (AgSession *)v8[1];
      *v8 = 0i64;
      v8[1] = 0i64;
    }
  }
  ++this->_Mypair._Myval2._Mylast;
}

__int64 __fastcall AgSession::remove(AgSession *this, AgPointer<AgUser> *user)
{
  AgMutex *p_m_mutex; // rbp
  AgPointer<AgUser> *Myfirst; // r8
  AgPointer<AgUser> *Mylast; // rax
  AgPointer<AgUser> *v7; // rsi
  AgPointer<KOFApplication> *v8; // rbx
  __int64 v9; // rax
  AgPointer<AgPlayer> v11; // [rsp+38h] [rbp-30h] BYREF

  p_m_mutex = &this->m_mutex;
  EnterCriticalSection((LPCRITICAL_SECTION)&this->m_mutex);
  Myfirst = this->m_users._Mypair._Myval2._Myfirst;
  Mylast = this->m_users._Mypair._Myval2._Mylast;
  if ( Myfirst == Mylast )
  {
LABEL_10:
    if ( this->m_users._Mypair._Myval2._Myfirst == Mylast )
      AgSession::stop(this);
    LeaveCriticalSection((LPCRITICAL_SECTION)p_m_mutex);
    AgPointer<AgUser>::~AgPointer<AgUser>((AgPointer<KOFApplication> *)user);
    return 0i64;
  }
  else
  {
    while ( Myfirst->m_ref != user->m_ref )
    {
      if ( ++Myfirst == Mylast )
        goto LABEL_10;
    }
    std::_Move_unchecked1<AgPointer<AgUser> *,AgPointer<AgUser> *>(
      Myfirst + 1,
      this->m_users._Mypair._Myval2._Mylast,
      Myfirst,
      0);
    v7 = this->m_users._Mypair._Myval2._Mylast;
    v8 = (AgPointer<KOFApplication> *)&v7[-1];
    if ( &v7[-1] != v7 )
    {
      do
        AgPointer<AgUser>::~AgPointer<AgUser>(v8++);
      while ( v8 != (AgPointer<KOFApplication> *)v7 );
    }
    --this->m_users._Mypair._Myval2._Mylast;
    if ( this->m_started )
    {
      AgPointer<AgBuffer<AgAllocator<1>>>::AgPointer<AgBuffer<AgAllocator<1>>>(&v11, (const AgPointer<AgPlayer> *)user);
      ((void (__fastcall *)(AgSession *, __int64))this->stopUser)(this, v9);
    }
    LeaveCriticalSection((LPCRITICAL_SECTION)p_m_mutex);
    AgPointer<AgUser>::~AgPointer<AgUser>((AgPointer<KOFApplication> *)user);
    return 1i64;
  }
}

__int64 __fastcall AgSession::start(AgSession *this)
{
  AgMutex *p_m_mutex; // rsi
  unsigned int v3; // er13
  AgSingleton<AgSessionManager> *v4; // rbx
  _RTL_CRITICAL_SECTION *v5; // rdi
  unsigned int v6; // er12
  __int64 v7; // rsi
  AgPointer<AgUser> *v8; // rsi
  volatile int *p_m_strongCount; // rdi
  int v10; // ebx
  int *v11; // rcx
  int v12; // ebx
  int *v13; // rdi
  volatile int *value[2]; // [rsp+30h] [rbp-50h] BYREF
  int v16; // [rsp+40h] [rbp-40h]
  AgMutex *v17; // [rsp+48h] [rbp-38h]
  int v18; // [rsp+50h] [rbp-30h]
  AgSingleton<AgSessionManager> *v19; // [rsp+58h] [rbp-28h]
  __int128 v20; // [rsp+60h] [rbp-20h] BYREF
  AgPointer<AgSession> _Val; // [rsp+70h] [rbp-10h] BYREF

  p_m_mutex = &this->m_mutex;
  v17 = &this->m_mutex;
  EnterCriticalSection((LPCRITICAL_SECTION)&this->m_mutex);
  v3 = 1;
  v16 = 1;
  if ( this->m_started || !this->startSession(this) )
    goto LABEL_24;
  if ( !this->isValid(this) )
  {
    AgPointer<AgSession>::AgPointer<AgSession>(&_Val, this);
    v4 = AgSingleton<AgSessionManager>::ms_instance;
    v5 = (_RTL_CRITICAL_SECTION *)&AgSingleton<AgSessionManager>::ms_instance[9];
    v19 = AgSingleton<AgSessionManager>::ms_instance + 9;
    EnterCriticalSection((LPCRITICAL_SECTION)&AgSingleton<AgSessionManager>::ms_instance[9]);
    std::vector<AgPointer<AgSession>>::push_back((std::vector<AgPointer<AgSession>> *)&v4[14], &_Val);
    LeaveCriticalSection(v5);
    v18 = 0;
    AgPointer<AgSession>::~AgPointer<AgSession>(&_Val);
    AgPlayerManager::flagPlayersDirty((AgPlayerManager *)AgSingleton<AgPlayerManager>::ms_instance);
LABEL_24:
    v3 = 0;
    goto LABEL_25;
  }
  this->m_started = 1;
  v6 = 0;
  if ( this->m_users._Mypair._Myval2._Mylast - this->m_users._Mypair._Myval2._Myfirst )
  {
    v7 = 0i64;
    do
    {
      v8 = &this->m_users._Mypair._Myval2._Myfirst[v7];
      *(_OWORD *)value = 0i64;
      p_m_strongCount = &v8->m_ref->m_strongCount;
      if ( !v8->m_ref )
        goto LABEL_14;
      v10 = *p_m_strongCount;
      if ( !*p_m_strongCount )
        goto LABEL_14;
      while ( (unsigned int)AgAtomicCompareExchange(p_m_strongCount, v10, v10 + 1) != v10 )
      {
        v10 = *p_m_strongCount;
        if ( !*p_m_strongCount )
          goto LABEL_14;
      }
      if ( v10 != -1 )
      {
        v11 = (int *)&v8->m_ref->m_strongCount;
        value[0] = &v8->m_ref->m_strongCount;
        value[1] = (volatile int *)v8->m_ptr;
      }
      else
      {
LABEL_14:
        v11 = (int *)value[0];
      }
      v20 = 0i64;
      if ( v11 )
      {
        v12 = *v11;
        if ( *v11 )
        {
          while ( 1 )
          {
            v13 = (int *)value[0];
            if ( (unsigned int)AgAtomicCompareExchange(value[0], v12, v12 + 1) == v12 )
              break;
            v12 = *v13;
            if ( !*v13 )
              goto LABEL_22;
          }
          if ( v12 != -1 )
            v20 = *(_OWORD *)value;
        }
      }
LABEL_22:
      ((void (__fastcall *)(AgSession *, __int128 *))this->startUser)(this, &v20);
      AgPointer<AgUser>::~AgPointer<AgUser>((AgPointer<KOFApplication> *)value);
      v7 = ++v6;
    }
    while ( v6 < (unsigned __int64)(this->m_users._Mypair._Myval2._Mylast - this->m_users._Mypair._Myval2._Myfirst) );
    p_m_mutex = v17;
  }
LABEL_25:
  LeaveCriticalSection((LPCRITICAL_SECTION)p_m_mutex);
  return v3;
}

void __fastcall AgSession::startUser(AgSession *this, AgPointer<AgUser> *user)
{
  AgPointer<AgPlayer> result; // [rsp+28h] [rbp-20h] BYREF

  if ( AgSingleton<AgPlayerManager>::ms_instance )
  {
    AgPlayerManager::getPlayerForUser(
      (AgPlayerManager *)AgSingleton<AgPlayerManager>::ms_instance,
      &result,
      user->m_ptr->m_id);
    if ( result.m_ptr )
      AgPlayer::lock(result.m_ptr);
    AgPointer<AgPlayer>::~AgPointer<AgPlayer>(&result);
  }
  AgPointer<AgUser>::~AgPointer<AgUser>((AgPointer<KOFApplication> *)user);
}

__int64 __fastcall AgSession::stop(AgSession *this)
{
  AgMutex *p_m_mutex; // rdi
  unsigned int v3; // er15
  AgPointer<AgUser> *Myfirst; // rbx
  volatile int *p_m_strongCount; // rsi
  int v6; // edi
  AgPointer<AgUser> v8; // [rsp+28h] [rbp-40h] BYREF
  int v9; // [rsp+38h] [rbp-30h]
  AgMutex *v10; // [rsp+40h] [rbp-28h]

  p_m_mutex = &this->m_mutex;
  v10 = &this->m_mutex;
  EnterCriticalSection((LPCRITICAL_SECTION)&this->m_mutex);
  v3 = 1;
  v9 = 1;
  if ( this->m_started && this->stopSession(this) )
  {
    this->m_started = 0;
    Myfirst = this->m_users._Mypair._Myval2._Myfirst;
    if ( Myfirst != this->m_users._Mypair._Myval2._Mylast )
    {
      do
      {
        v8 = 0i64;
        p_m_strongCount = &Myfirst->m_ref->m_strongCount;
        if ( Myfirst->m_ref )
        {
          v6 = *p_m_strongCount;
          if ( *p_m_strongCount )
          {
            while ( (unsigned int)AgAtomicCompareExchange(p_m_strongCount, v6, v6 + 1) != v6 )
            {
              v6 = *p_m_strongCount;
              if ( !*p_m_strongCount )
                goto LABEL_11;
            }
            if ( v6 != -1 )
              v8 = *Myfirst;
          }
        }
LABEL_11:
        ((void (__fastcall *)(AgSession *, AgPointer<AgUser> *))this->stopUser)(this, &v8);
        ++Myfirst;
      }
      while ( Myfirst != this->m_users._Mypair._Myval2._Mylast );
      p_m_mutex = v10;
    }
  }
  else
  {
    v3 = 0;
  }
  LeaveCriticalSection((LPCRITICAL_SECTION)p_m_mutex);
  return v3;
}

void __fastcall AgSession::stopUser(AgSession *this, AgPointer<AgUser> *user)
{
  AgPointer<AgPlayer> result; // [rsp+28h] [rbp-20h] BYREF

  if ( AgSingleton<AgPlayerManager>::ms_instance )
  {
    AgPlayerManager::getPlayerForUser(
      (AgPlayerManager *)AgSingleton<AgPlayerManager>::ms_instance,
      &result,
      user->m_ptr->m_id);
    if ( result.m_ptr->m_id != -1 )
      AgPlayer::unlock(result.m_ptr);
    AgPointer<AgPlayer>::~AgPointer<AgPlayer>(&result);
  }
  AgPointer<AgUser>::~AgPointer<AgUser>((AgPointer<KOFApplication> *)user);
}

void __fastcall AgPlayer::unlock(AgPlayer *this)
{
  AgMutex *p_m_mutex; // rbx

  p_m_mutex = &this->m_mutex;
  EnterCriticalSection((LPCRITICAL_SECTION)&this->m_mutex);
  AgPlayer::clearControllers(this);
  this->m_dirty |= this->m_locked;
  this->m_locked = 0;
  LeaveCriticalSection((LPCRITICAL_SECTION)p_m_mutex);
}

